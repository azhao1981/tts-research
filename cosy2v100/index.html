<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTS æµå¼è¾¹ä¸‹è¾¹æ’­æµ‹è¯•</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 1000px; margin: 2rem auto; padding: 20px; background-color: #f7f9fc; }
        .container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .input-group { margin-bottom: 15px; }
        label { display: block; font-weight: 600; margin-bottom: 5px; color: #374151; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; box-sizing: border-box; }
        .btn { width: 100%; background-color: #2563eb; color: white; border: none; padding: 15px; font-weight: bold; border-radius: 8px; cursor: pointer; margin-top: 10px; }
        .btn:disabled { background-color: #9ca3af; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9rem; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
        .b-stream { background: #dcfce7; color: #15803d; } /* ç»¿è‰² */
        .b-done { background: #e5e7eb; color: #374151; }
    </style>
</head>
<body>

<div class="container">
    <h2>TTS çœŸæ­£çš„æµå¼æ’­æ”¾ (Stream Playback)</h2>

    <div class="input-group">
        <label>æ¥å£åœ°å€</label>
        <input type="text" id="apiUrl" value="http://127.0.0.1:13099/stream">
    </div>
    
    <div class="input-group">
        <label>1. å‚è€ƒéŸ³é¢‘ (Prompt Audio)</label>
        <input type="file" id="audioFile" accept=".wav">
    </div>

    <div class="input-group">
        <label>2. ç›®æ ‡æ–‡æœ¬</label>
        <input type="text" id="textInput" value="ä½ å¥½ï¼Œè¿™æ˜¯ä¸€ä¸ªçœŸæ­£çš„æµå¼æ’­æ”¾æµ‹è¯•ã€‚ä½ ä¼šå‘ç°ï¼Œæˆ‘è¿˜æ²¡æ¥æ”¶å®Œï¼Œå£°éŸ³å°±å·²ç»å‡ºæ¥äº†ã€‚">
    </div>

    <div class="input-group">
        <label>3. æç¤ºæ–‡æœ¬ (Prompt Text) - åŠ¡å¿…ä¸éŸ³é¢‘å†…å®¹ä¸€è‡´ï¼</label>
        <textarea id="promptTextInput" rows="3">å’±ä»¬è¿™ä¸ªé¡¹ç›®å‘¢å±äºæ˜¯æŠ•å…¥ä½ï¼Œå›æœ¬å¿«ï¼Œè€Œä¸”ç°åœ¨åŠ ç›Ÿå‘¢è¿˜æœ‰ä¸€äº›æ”¿ç­–ä¸Šçš„è¿™ä¸ªä¼˜æƒ ï¼Œå‘ƒï¼Œæ‚¨çœ‹æˆ‘åç»­è®©æ‹›å•†ç»ç†è”ç³»æ‚¨ï¼Œç»™æ‚¨è¯¦ç»†ä»‹ç»ä¸€ä¸‹å¯ä»¥å—ï¼Ÿå‘ƒï¼Œä¸ä¼šå ç”¨æ‚¨å¤ªå¤šæ—¶é—´çš„ï¼Œä¹Ÿæ˜¯ç»™æ‚¨è‡ªå·±ä¸€ä¸ªèµšé’±çš„æœºä¼šå˜›ã€‚</textarea>
    </div>

    <button id="startBtn" class="btn" onclick="startTest()">ğŸš€ å¼€å§‹æµå¼æµ‹è¯•</button>

    <div style="margin-top:20px; display:flex; gap:20px; font-weight:bold; color:#2563eb;">
        <div>é¦–å“ (TTFB): <span id="statTtfb">-</span> ms</div>
    </div>

    <table>
        <thead>
            <tr>
                <th>çŠ¶æ€</th>
                <th>è¿›åº¦</th>
                <th>é¦–å“ (ms)</th>
                <th>è¯´æ˜</th>
            </tr>
        </thead>
        <tbody id="resultBody"></tbody>
    </table>
</div>

<script>
    // å…¨å±€ AudioContext
    let audioCtx;
    
    async function startTest() {
        const url = document.getElementById('apiUrl').value;
        const text = document.getElementById('textInput').value;
        const promptText = document.getElementById('promptTextInput').value;
        const fileInput = document.getElementById('audioFile');
        const btn = document.getElementById('startBtn');

        if (fileInput.files.length === 0) { alert("è¯·é€‰æ‹©å‚è€ƒéŸ³é¢‘"); return; }
        
        // 1. åˆå§‹åŒ– AudioContext
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') await audioCtx.resume();

        // 2. å‡†å¤‡ UI
        btn.disabled = true;
        const tbody = document.getElementById('resultBody');
        tbody.innerHTML = '';
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><span class="badge" style="background:#eee">å‡†å¤‡ä¸­</span></td>
            <td class="progress">0%</td>
            <td class="ttfb">-</td>
            <td class="info">è¯·æ±‚å·²å‘é€...</td>
        `;
        tbody.appendChild(tr);

        // 3. æ„é€ è¯·æ±‚
        const formData = new FormData();
        formData.append('text', text);
        formData.append('prompt_text', promptText);
        formData.append('prompt_audio', fileInput.files[0]);

        const startTime = performance.now();
        let ttfb = 0;
        let receivedBytes = 0;
        
        // ==========================================
        // ğŸµ éŸ³é¢‘æµå¼æ’­æ”¾æ ¸å¿ƒå˜é‡
        // ==========================================
        let nextStartTime = 0; // ä¸‹ä¸€æ®µéŸ³é¢‘çš„æ’­æ”¾èµ·å§‹æ—¶é—´
        const SAMPLE_RATE = 24000; // å¿…é¡»ä¸æœåŠ¡å™¨ä¸€è‡´ (CosyVoice é»˜è®¤ 24k)
        let isFirstChunk = true;   // ç”¨äºè·³è¿‡ WAV å¤´

        try {
            const response = await fetch(url, { method: 'POST', body: formData });
            if (!response.body) throw new Error("ä¸æ”¯æŒæµå¼å“åº”");
            
            const reader = response.body.getReader();
            
            tr.querySelector('.badge').className = 'badge b-stream';
            tr.querySelector('.badge').innerText = 'æ’­æ”¾ä¸­';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                // 1. è®°å½•é¦–å“
                if (ttfb === 0) {
                    ttfb = performance.now() - startTime;
                    document.getElementById('statTtfb').innerText = ttfb.toFixed(0);
                    tr.querySelector('.ttfb').innerText = ttfb.toFixed(0);
                    
                    // åˆå§‹åŒ–æ’­æ”¾æ—¶é—´ï¼šå¦‚æœå½“å‰æ—¶é—´æ¯” context æ—¶é—´æ™šï¼Œå°±ä»å½“å‰å¼€å§‹
                    // ç¨å¾®åŠ ä¸€ç‚¹ç‚¹å»¶è¿Ÿ(0.1s)ä¿è¯å¹³æ»‘
                    nextStartTime = audioCtx.currentTime + 0.1;
                }

                // 2. å¤„ç†éŸ³é¢‘æ•°æ® (æ ¸å¿ƒé€»è¾‘)
                let audioData = value; // Uint8Array

                // å¦‚æœæ˜¯ç¬¬ä¸€åŒ…ï¼Œé‡Œé¢åŒ…å« 44å­—èŠ‚çš„ WAV å¤´ï¼Œå¿…é¡»åˆ‡æ‰ï¼Œå¦åˆ™ä¼šçˆ†éŸ³
                if (isFirstChunk) {
                    if (audioData.length > 44) {
                        audioData = audioData.slice(44);
                    }
                    isFirstChunk = false;
                }

                // 3. å°†äºŒè¿›åˆ¶æµ (Int16) è½¬æ¢ä¸º WebAudio èƒ½å¤Ÿæ’­æ”¾çš„ (Float32)
                // æ³¨æ„ï¼šæœåŠ¡å™¨è¿”å›çš„æ˜¯ PCM 16bit Little Endian
                // Uint8Array (bytes) -> Int16Array (samples)
                // ç¡®ä¿å­—èŠ‚å¯¹é½ (æœ‰äº›ç½‘ç»œåŒ…å¯èƒ½ä¸æ˜¯å¶æ•°é•¿åº¦ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå‡è®¾æ˜¯å¶æ•°)
                if (audioData.length % 2 !== 0) {
                    // ç®€å•æˆªæ–­å¤šä½™çš„ä¸€ä¸ªå­—èŠ‚ï¼Œé˜²æ­¢æŠ¥é”™
                    audioData = audioData.slice(0, audioData.length - 1);
                }
                
                const int16Data = new Int16Array(audioData.buffer, audioData.byteOffset, audioData.byteLength / 2);
                const float32Data = new Float32Array(int16Data.length);
                
                // å½’ä¸€åŒ–ï¼šå°† Int16 [-32768, 32767] æ˜ å°„åˆ° Float32 [-1.0, 1.0]
                for (let i = 0; i < int16Data.length; i++) {
                    float32Data[i] = int16Data[i] / 32768.0;
                }

                // 4. åˆ›å»º AudioBuffer å¹¶æ’­æ”¾
                if (float32Data.length > 0) {
                    const audioBuffer = audioCtx.createBuffer(1, float32Data.length, SAMPLE_RATE);
                    audioBuffer.copyToChannel(float32Data, 0);

                    const source = audioCtx.createBufferSource();
                    source.buffer = audioBuffer;
                    source.connect(audioCtx.destination);
                    
                    // è°ƒåº¦æ’­æ”¾ï¼šæ— ç¼è¡”æ¥
                    // å¦‚æœè®¡ç®—å‡ºçš„ä¸‹ä¸€å—æ—¶é—´å·²ç»è¿‡å»äº†(ç½‘ç»œå¡é¡¿)ï¼Œå°±é‡ç½®ä¸ºå½“å‰æ—¶é—´
                    if (nextStartTime < audioCtx.currentTime) {
                        nextStartTime = audioCtx.currentTime;
                    }
                    
                    source.start(nextStartTime);
                    // æ›´æ–°ä¸‹ä¸€å—çš„å¼€å§‹æ—¶é—´
                    nextStartTime += audioBuffer.duration;
                }

                // æ›´æ–°ç•Œé¢
                receivedBytes += value.length;
                tr.querySelector('.progress').innerText = (receivedBytes / 1024).toFixed(0) + ' KB';
            }

            tr.querySelector('.info').innerText = "æ¥æ”¶å¹¶æ’­æ”¾å®Œæ¯•";
            tr.querySelector('.badge').className = 'badge b-done';
            tr.querySelector('.badge').innerText = 'å®Œæˆ';

        } catch (e) {
            console.error(e);
            tr.querySelector('.info').innerText = "å‡ºé”™: " + e.message;
        } finally {
            btn.disabled = false;
        }
    }
</script>

</body>
</html>