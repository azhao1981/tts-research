<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTS è¯­éŸ³åˆæˆå‹æµ‹å·¥å…· (Multipart/Form-data)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 1100px; margin: 2rem auto; padding: 0 20px; background-color: #f7f9fc; }
        .container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        /* é¡¶éƒ¨è¾“å…¥åŒºå¸ƒå±€ */
        .config-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .full-width { grid-column: 1 / -1; }
        
        .input-group label { display: block; font-weight: 600; margin-bottom: 6px; color: #374151; font-size: 0.9rem; }
        .input-group input, .input-group textarea { width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-family: inherit; box-sizing: border-box; }
        .input-group textarea { height: 80px; resize: vertical; }
        
        .file-upload-box { border: 2px dashed #3b82f6; background: #eff6ff; padding: 15px; border-radius: 8px; text-align: center; color: #1e40af; cursor: pointer; transition: 0.2s; }
        .file-upload-box:hover { background: #dbeafe; }
        
        button#startBtn { width: 100%; background-color: #2563eb; color: white; border: none; padding: 15px; font-size: 1.1rem; font-weight: bold; border-radius: 8px; cursor: pointer; transition: 0.2s; margin-top: 10px; }
        button#startBtn:hover { background-color: #1d4ed8; }
        button#startBtn:disabled { background-color: #9ca3af; cursor: not-allowed; }

        /* ç»Ÿè®¡æ  */
        .stats-bar { display: flex; gap: 15px; margin: 20px 0; padding: 15px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; justify-content: space-around; }
        .stat-item div:first-child { font-size: 0.85rem; color: #166534; }
        .stat-item div:last-child { font-size: 1.5rem; font-weight: bold; color: #15803d; }

        /* è¡¨æ ¼ */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-top: 20px; background: white; }
        th { text-align: left; padding: 12px; background-color: #f3f4f6; color: #4b5563; font-weight: 600; }
        td { padding: 12px; border-bottom: 1px solid #e5e7eb; vertical-align: middle; }
        
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 600; }
        .b-wait { background: #f3f4f6; color: #6b7280; }
        .b-stream { background: #fef3c7; color: #d97706; }
        .b-play { background: #dcfce7; color: #15803d; }
        .b-done { background: #e5e7eb; color: #374151; }
        .b-error { background: #fee2e2; color: #b91c1c; }
        
        .error-msg { color: #dc2626; font-size: 0.8rem; margin-top: 5px; }

        /* æ’­æ”¾æŒ‰é’®æ ·å¼ */
        .play-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }
        .play-btn:hover { background: #059669; }
        .play-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .play-btn.playing {
            background: #f59e0b;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* å†å²è®°å½•è¡¨æ ¼æ ·å¼ */
        .history-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e5e7eb;
        }
        .history-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .history-title h3 {
            margin: 0;
            font-size: 1.2rem;
            color: #374151;
        }
        .clear-history-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .clear-history-btn:hover {
            background: #dc2626;
        }
        #historyTable {
            font-size: 0.85rem;
        }
        #historyTable th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #4b5563;
        }
        #historyTable td {
            padding: 10px 12px;
        }
        .batch-info {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 5px;
        }
    </style>
</head>
<body>

<div class="container">
    <h2 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:15px;">TTS è¯­éŸ³åˆæˆå‹æµ‹ (Multipart/Form-data)</h2>

    <div class="config-grid">
        <div class="full-width input-group">
            <label>æ¥å£åœ°å€ (URL)</label>
            <input type="text" id="apiUrl" value="http://127.0.0.1:13099/stream">
        </div>

        <div class="input-group">
            <label>1. å‚è€ƒéŸ³é¢‘ (Prompt Audio) <span style="color:red">*å¿…å¡«</span></label>
            <input type="file" id="audioFile" accept=".wav,.mp3">
            <div style="font-size: 0.8rem; color: #666; margin-top: 4px;">ç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œå¿…é¡»æ‰‹åŠ¨é€‰æ‹©æœ¬åœ°æ–‡ä»¶ (å¦‚ xiangyu.wav)</div>
        </div>
        
        <div class="input-group">
            <label>å¹¶å‘æ•° (Concurrency)</label>
            <input type="number" id="concurrency" value="1" min="1" max="20">
        </div>

        <div class="full-width input-group">
            <label>2. ç›®æ ‡æ–‡æœ¬ (Text)</label>
            <textarea id="textInput">å–‚ï¼Œæå…ˆç”Ÿæ‚¨å¥½ï¼Œæˆ‘è¿™è¾¹æ˜¯å…ˆé”‹æ•™è‚²çš„ç‹è€å¸ˆã€‚æ‰“ç”µè¯æ˜¯æƒ³è·Ÿæ‚¨åŒæ­¥ä¸€ä¸ªå¯¹æ‚¨å®¶å­©å­å¯èƒ½æœ‰ç”¨çš„ä¿¡æ¯ã€‚</textarea>
        </div>

        <div class="full-width input-group">
            <label>3. æç¤ºæ–‡æœ¬ (Prompt Text)</label>
            <textarea id="promptTextInput">å’±ä»¬è¿™ä¸ªé¡¹ç›®å‘¢å±äºæ˜¯æŠ•å…¥ä½ï¼Œå›æœ¬å¿«ï¼Œè€Œä¸”ç°åœ¨åŠ ç›Ÿå‘¢è¿˜æœ‰ä¸€äº›æ”¿ç­–ä¸Šçš„è¿™ä¸ªä¼˜æƒ ï¼Œå‘ƒï¼Œæ‚¨çœ‹æˆ‘åç»­è®©æ‹›å•†ç»ç†è”ç³»æ‚¨ï¼Œç»™æ‚¨è¯¦ç»†ä»‹ç»ä¸€ä¸‹å¯ä»¥å—ï¼Ÿå‘ƒï¼Œä¸ä¼šå ç”¨æ‚¨å¤ªå¤šæ—¶é—´çš„ï¼Œä¹Ÿæ˜¯ç»™æ‚¨è‡ªå·±ä¸€ä¸ªèµšé’±çš„æœºä¼šå˜›ã€‚</textarea>
        </div>
    </div>

    <button id="startBtn" onclick="startTest()">ğŸš€ å¼€å§‹æµ‹è¯• (Start)</button>

    <div class="stats-bar">
        <div class="stat-item"><div>å¹³å‡é¦–å“ (TTFB)</div><div id="avgTtfb">-</div></div>
        <div class="stat-item"><div>å¹³å‡ RTF</div><div id="avgRtf">-</div></div>
        <div class="stat-item"><div>æˆåŠŸç‡</div><div id="successRate">0%</div></div>
    </div>

    <table>
        <thead>
            <tr>
                <th style="width:50px">#</th>
                <th>çŠ¶æ€</th>
                <th>æ“ä½œ</th>
                <th>TTFB (ms)</th>
                <th>æ¥æ”¶è€—æ—¶ (ms)</th>
                <th>éŸ³é¢‘æ—¶é•¿ (s)</th>
                <th>RTF</th>
            </tr>
        </thead>
        <tbody id="resultBody"></tbody>
    </table>

    <!-- å†å²è®°å½•åŒºåŸŸ -->
    <div class="history-section">
        <div class="history-title">
            <h3>æµ‹è¯•è®°å½•</h3>
            <button class="clear-history-btn" onclick="clearHistory()">æ¸…ç©ºè®°å½•</button>
        </div>
        <table id="historyTable">
            <thead>
                <tr>
                    <th>æ‰¹æ¬¡ ID</th>
                    <th>å¼€å§‹æ—¶é—´</th>
                    <th>é¦–å“æ—¶é—´</th>
                    <th>ç»“æŸæ—¶é—´</th>
                    <th>#</th>
                    <th>TTFB (ms)</th>
                    <th>è€—æ—¶ (ms)</th>
                    <th>æ—¶é•¿ (s)</th>
                    <th>RTF</th>
                    <th>çŠ¶æ€</th>
                </tr>
            </thead>
            <tbody id="historyBody"></tbody>
        </table>
    </div>
</div>

<script>
    let audioCtx;
    let testStartTime;
    let currentBatchId;
    let testHistory = JSON.parse(localStorage.getItem('ttsTestHistory') || '[]');

    // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºå†å²è®°å½•
    window.onload = () => {
        loadHistory();
    };

    async function startTest() {
        // 1. è·å–è¾“å…¥
        const url = document.getElementById('apiUrl').value;
        const text = document.getElementById('textInput').value;
        const promptText = document.getElementById('promptTextInput').value;
        const fileInput = document.getElementById('audioFile');
        const count = parseInt(document.getElementById('concurrency').value);

        // 0. è®°å½•æµ‹è¯•å¼€å§‹æ—¶é—´å’Œæ‰¹æ¬¡ID
        testStartTime = new Date();
        currentBatchId = 'B' + Date.now().toString().slice(-6);

        // 2. æ ¡éªŒæ–‡ä»¶
        if (fileInput.files.length === 0) {
            alert("âŒ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå‚è€ƒéŸ³é¢‘æ–‡ä»¶ (.wav)ï¼\næµè§ˆå™¨æ— æ³•è‡ªåŠ¨è¯»å–æœ¬åœ°æ–‡ä»¶ã€‚");
            return;
        }
        const promptFile = fileInput.files[0];

        // 3. ç•Œé¢é‡ç½®
        const btn = document.getElementById('startBtn');
        const tbody = document.getElementById('resultBody');
        btn.disabled = true;
        tbody.innerHTML = '';
        document.getElementById('avgTtfb').innerText = '-';
        document.getElementById('avgRtf').innerText = '-';
        document.getElementById('successRate').innerText = '0%';

        // 4. åˆå§‹åŒ–éŸ³é¢‘å¼•æ“ (è§£å†³è‡ªåŠ¨æ’­æ”¾ç­–ç•¥)
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') await audioCtx.resume();

        // 5. å¹¶å‘æ‰§è¡Œ
        const requests = [];
        for (let i = 0; i < count; i++) {
            requests.push(runSingleTask(i + 1, url, text, promptText, promptFile));
        }

        await Promise.all(requests);
        btn.disabled = false;
    }

    async function runSingleTask(id, url, text, promptText, file) {
        // åˆ›å»ºè¡¨æ ¼è¡Œ
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${id}</td>
            <td><span class="badge b-wait">å‡†å¤‡ä¸­</span></td>
            <td><button class="play-btn" disabled>â–¶ï¸ æ’­æ”¾</button></td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
        `;
        document.getElementById('resultBody').appendChild(tr);

        // å‡†å¤‡ FormData (å¯¹åº” Python çš„ data å’Œ files)
        const formData = new FormData();
        formData.append('text', text);
        formData.append('prompt_text', promptText);
        // æ³¨æ„ï¼šè¿™é‡Œå¯¹åº” files={'prompt_audio': ...}
        formData.append('prompt_audio', file);

        const startTime = performance.now();
        let ttfb = 0;
        let ttfbTime = null; // è®°å½•é¦–å“çš„å®é™…æ—¶é—´

        try {
            // å‘èµ·è¯·æ±‚
            const response = await fetch(url, {
                method: 'POST',
                body: formData // Fetch ä¼šè‡ªåŠ¨è®¾ç½® Content-Type ä¸º multipart/form-data
            });

            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            if (!response.body) throw new Error('ReadableStream ä¸æ”¯æŒ');

            const reader = response.body.getReader();
            let chunks = [];
            let receivedLength = 0;
            
            updateStatus(tr, 'b-stream', 'æ¥æ”¶æµ...');

            // è¯»å–æµ
            while (true) {
                const {done, value} = await reader.read();
                
                // æ”¶åˆ°ç¬¬ä¸€ä¸ªåŒ…ï¼šè®°å½• TTFB
                if (ttfb === 0) {
                    ttfb = performance.now() - startTime;
                    ttfbTime = new Date(); // è®°å½•é¦–å“çš„å®é™…æ—¶é—´
                    tr.cells[3].innerText = ttfb.toFixed(0);
                }

                if (done) break;
                
                chunks.push(value);
                receivedLength += value.length;
            }

            // æ¥æ”¶å®Œæˆ
            const endTime = performance.now();
            const totalTime = endTime - startTime; // ç½‘ç»œä¼ è¾“æ€»è€—æ—¶
            const actualEndTime = new Date(); // è®°å½•ç»“æŸçš„å®é™…æ—¶é—´
            tr.cells[4].innerText = totalTime.toFixed(0);

            // åˆå¹¶äºŒè¿›åˆ¶æ•°æ®
            let chunksAll = new Uint8Array(receivedLength);
            let position = 0;
            for(let chunk of chunks) {
                chunksAll.set(chunk, position);
                position += chunk.length;
            }

            // è§£ç éŸ³é¢‘è·å–æ—¶é•¿ (è®¡ç®— RTF å¿…é¡»)
            // Pythonä»£ç é‡Œæ˜¯ç›´æ¥å†™æ–‡ä»¶ï¼Œæµè§ˆå™¨é‡Œæˆ‘ä»¬è§£ç æ¥ç®—æ—¶é•¿
            const audioBuffer = await audioCtx.decodeAudioData(chunksAll.buffer);
            const duration = audioBuffer.duration;

            // è®¡ç®— RTF = å¤„ç†è€—æ—¶ / éŸ³é¢‘æ—¶é•¿
            const rtf = (totalTime / 1000) / duration;

            tr.cells[5].innerText = duration.toFixed(2);
            tr.cells[6].innerText = rtf.toFixed(3);

            // å­˜å‚¨éŸ³é¢‘æ•°æ®å¹¶å¯ç”¨æ’­æ”¾æŒ‰é’®
            tr.audioBuffer = audioBuffer;
            tr.dataset.ttfb = ttfb;
            tr.dataset.rtf = rtf;
            tr.dataset.success = "1";

            // å¯ç”¨æ’­æ”¾æŒ‰é’®
            const playBtn = tr.querySelector('.play-btn');
            if (playBtn) {
                playBtn.disabled = false;
                playBtn.onclick = () => playAudioOnClick(tr);
            }

            // ä¿å­˜å•æ¡æµ‹è¯•è®°å½•
            saveSingleTestResult(id, ttfb, totalTime, duration, rtf, true, ttfbTime, actualEndTime);

            updateStatsSummary();
            updateStatus(tr, 'b-done', 'å°±ç»ª');

        } catch (e) {
            console.error(e);
            updateStatus(tr, 'b-error', 'å¤±è´¥');
            tr.cells[4].innerHTML = `<div class="error-msg">${e.message}</div>`;

            // ä¿å­˜å¤±è´¥è®°å½•
            saveSingleTestResult(id, 0, 0, 0, 0, false, null, new Date());
        }
    }

    function playAudio(buffer, tr) {
        const source = audioCtx.createBufferSource();
        source.buffer = buffer;
        source.connect(audioCtx.destination);
        source.start(0);
        source.onended = () => {
            updateStatus(tr, 'b-done', 'å°±ç»ª');
            const playBtn = tr.querySelector('.play-btn');
            if (playBtn) {
                playBtn.classList.remove('playing');
                playBtn.innerText = 'â–¶ï¸ æ’­æ”¾';
            }
        };
    }

    // ç‚¹å‡»æ’­æ”¾åŠŸèƒ½
    function playAudioOnClick(tr) {
        const playBtn = tr.querySelector('.play-btn');

        // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œåœæ­¢æ’­æ”¾
        if (playBtn.classList.contains('playing')) {
            // åœæ­¢å½“å‰æ’­æ”¾çš„éŸ³é¢‘
            if (tr.currentSource) {
                tr.currentSource.stop();
                tr.currentSource = null;
            }
            return;
        }

        // æ£€æŸ¥æ˜¯å¦æœ‰éŸ³é¢‘æ•°æ®
        if (!tr.audioBuffer) {
            alert('æ²¡æœ‰å¯æ’­æ”¾çš„éŸ³é¢‘æ•°æ®');
            return;
        }

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        playBtn.classList.add('playing');
        playBtn.innerText = 'â¸ï¸ åœæ­¢';
        updateStatus(tr, 'b-play', 'æ’­æ”¾ä¸­');

        // åˆ›å»ºå¹¶æ’­æ”¾éŸ³é¢‘
        const source = audioCtx.createBufferSource();
        source.buffer = tr.audioBuffer;
        source.connect(audioCtx.destination);
        source.start(0);

        // ä¿å­˜ source å¼•ç”¨ä»¥ä¾¿åœæ­¢
        tr.currentSource = source;

        // æ’­æ”¾ç»“æŸå¤„ç†
        source.onended = () => {
            playBtn.classList.remove('playing');
            playBtn.innerText = 'â–¶ï¸ æ’­æ”¾';
            updateStatus(tr, 'b-done', 'å°±ç»ª');
            tr.currentSource = null;
        };
    }

    function updateStatus(tr, badgeClass, text) {
        tr.cells[1].innerHTML = `<span class="badge ${badgeClass}">${text}</span>`;
    }

    function updateStatsSummary() {
        const rows = Array.from(document.querySelectorAll('#resultBody tr'));
        const successRows = rows.filter(r => r.dataset.success === "1");

        if (successRows.length === 0) return;

        // è®¡ç®—å¹³å‡å€¼
        const avgTtfb = successRows.reduce((a, r) => a + parseFloat(r.dataset.ttfb), 0) / successRows.length;
        const avgRtf = successRows.reduce((a, r) => a + parseFloat(r.dataset.rtf), 0) / successRows.length;

        document.getElementById('avgTtfb').innerText = avgTtfb.toFixed(0) + ' ms';
        document.getElementById('avgRtf').innerText = avgRtf.toFixed(3);

        const total = document.getElementById('concurrency').value;
        document.getElementById('successRate').innerText = Math.round((successRows.length / total) * 100) + '%';
    }

    // ä¿å­˜å•æ¡æµ‹è¯•è®°å½•
    function saveSingleTestResult(id, ttfb, time, duration, rtf, success, ttfbTime, endTime) {
        const record = {
            batchId: currentBatchId,
            startTime: testStartTime.toISOString(),
            ttfbTime: ttfbTime ? ttfbTime.toISOString() : null,
            endTime: endTime ? endTime.toISOString() : null,
            id: id,
            ttfb: ttfb.toFixed(0),
            time: time.toFixed(0),
            duration: duration.toFixed(2),
            rtf: rtf.toFixed(3),
            success: success
        };

        // æ·»åŠ åˆ°å†å²è®°å½•
        testHistory.unshift(record);

        // é™åˆ¶å†å²è®°å½•æ•°é‡ï¼ˆæœ€å¤šä¿å­˜200æ¡ï¼Œå› ä¸ºæ˜¯å•ä¸ªè¯·æ±‚çš„è®°å½•ï¼‰
        if (testHistory.length > 200) {
            testHistory = testHistory.slice(0, 200);
        }

        // ä¿å­˜åˆ° localStorage
        localStorage.setItem('ttsTestHistory', JSON.stringify(testHistory));

        // æ›´æ–°æ˜¾ç¤º
        loadHistory();
    }

    // åŠ è½½å†å²è®°å½•
    function loadHistory() {
        const tbody = document.getElementById('historyBody');
        tbody.innerHTML = '';

        if (testHistory.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #999;">æš‚æ— æµ‹è¯•è®°å½•</td></tr>';
            return;
        }

        testHistory.forEach(record => {
            const tr = document.createElement('tr');
            const startTime = new Date(record.startTime);
            const ttfbTime = record.ttfbTime ? new Date(record.ttfbTime) : null;
            const endTime = record.endTime ? new Date(record.endTime) : null;

            tr.innerHTML = `
                <td><strong>${record.batchId}</strong></td>
                <td>${formatTime(startTime)}</td>
                <td>${ttfbTime ? formatTime(ttfbTime) : '-'}</td>
                <td>${endTime ? formatTime(endTime) : '-'}</td>
                <td>${record.id || '-'}</td>
                <td>${record.success ? record.ttfb : '-'}</td>
                <td>${record.success ? record.time : '-'}</td>
                <td>${record.success ? record.duration : '-'}</td>
                <td>${record.success ? record.rtf : '-'}</td>
                <td>${record.success ?
                    '<span class="badge b-done">æˆåŠŸ</span>' :
                    '<span class="badge b-error">å¤±è´¥</span>'}</td>
            `;

            tbody.appendChild(tr);
        });
    }

    // æ¸…ç©ºå†å²è®°å½•
    function clearHistory() {
        if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æµ‹è¯•è®°å½•å—ï¼Ÿ')) {
            testHistory = [];
            localStorage.removeItem('ttsTestHistory');
            loadHistory();
        }
    }

    // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
    function formatTime(date) {
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        const seconds = date.getSeconds().toString().padStart(2, '0');
        const milliseconds = date.getMilliseconds().toString().padStart(3, '0');
        return `${hours}:${minutes}:${seconds}.${milliseconds}`;
    }
</script>

</body>
</html>